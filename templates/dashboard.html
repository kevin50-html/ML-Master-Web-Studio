<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comunidad — Master Web Studio</title>

  <!-- CSS global -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <style>
    body { background:#fff; }
    .container-narrow { max-width: 920px; margin: 28px auto; padding: 0 16px; }

    /* Topbar */
    .dash-topbar{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 18px;
    }
    .dash-actions .btn{ margin-left: 8px; }

    /* Cards */
    .card{ border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
    .card-header{ background:#fff; border-bottom:1px solid #eef2f7; }
    .card-body{ width: 300px;          /* Ancho fijo */
    height: auto;          /* Alto automático según contenido */
    padding: 20px;         /* Espacio interno */
    margin: 20px auto;     /* Centrar horizontalmente */ }

    /* Botones suaves */
    .btn-soft{
      background:#f8fafc; border:1px solid #e5e7eb; color:#0f172a;
    }
    .btn-soft:hover{ background:#eef2f7; }

    /* EDITOR */
    .editor-box{
      display:block;
      width:100%;
      border: 1.5px dashed #cbd5e1;
      border-radius: 12px;
      padding: 14px;
      background:#fff;
      outline:none;
      box-sizing:border-box;

      /* comportamiento de texto */
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.5;

      /* auto-grow limitado */
      min-height: 140px;
      max-height: 60vh;
      overflow-y: auto;
    }

    /* asegura que no se desborde horizontalmente */
    .editor-box::-webkit-scrollbar {
      width: 8px;
    }

    .editor-box:focus{
      border-color:#94a3b8;
      box-shadow: inset 0 0 0 2px rgba(99,102,241,.12);
    }

    .editor-placeholder:empty:before{
      content: attr(data-placeholder);
      color:#94a3b8;
    }

    .muted{ color:#64748b; }
    .char-counter{ font-size:.85rem; color:#94a3b8; }

    /* POSTS */
    .post-card{ border:1px solid #eef2f7; border-radius:12px; padding:14px; margin-bottom:12px; }
    .post-header{ display:flex; align-items:center; justify-content:space-between; }
    .post-meta{ font-size:.9rem; color:#64748b; }
    .post-actions a{ margin-left: 10px; text-decoration:none; }
    .post-actions a:hover{ text-decoration:underline; }

    /* Contenido del post y textarea de edición con wrap */
    .post-content,
    .textarea-like{
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.5;
    }
    .textarea-like{
      width:100%;
      min-height: 110px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:10px;
      resize: none;
      box-sizing:border-box;
    }
  </style>
</head>
<body>

  <div class="container-narrow">

    <!-- TOP BAR -->
    <div class="dash-topbar">
      <h2 class="m-0">Comunidad</h2>
      <div class="dash-actions">
        <a class="btn btn-soft" href="{{ url_for('main.index') }}">← Inicio</a>
        <a class="btn btn-outline-danger" href="{{ url_for('auth.logout') }}">Cerrar sesión</a>
      </div>
    </div>

    <!-- FLASHES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, msg in messages %}
            <div class="alert alert-{{ 'secondary' if category=='info' else category }} py-2 mb-2">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- EDITOR -->
    <div class="card mb-4">
      <div class="card-body">
        <div id="editor"
             class="editor-box editor-placeholder"
             contenteditable="true"
             data-placeholder="Escribe algo…"></div>

        <div class="d-flex align-items-center justify-content-between mt-2">
          <small class="muted char-counter" id="charCounter">0 caracteres</small>
          <div class="d-flex gap-2">
            <button id="postBtn" class="btn btn-primary">Publicar</button>
            <button id="clearBtn" class="btn btn-soft" type="button">Limpiar</button>
          </div>
        </div>

        <small class="muted d-block mt-2">Tip: el recuadro es editable (contenteditable).</small>
      </div>
    </div>

    <!-- LISTA DE POSTS -->
    <div id="postsList"></div>

  </div>

  <script>
  (function(){
    const editor   = document.getElementById('editor');
    const postBtn  = document.getElementById('postBtn');
    const clearBtn = document.getElementById('clearBtn');
    const list     = document.getElementById('postsList');
    const counter  = document.getElementById('charCounter');

    /* -------- API -------- */
    const api = {
      list:  () => fetch('/api/posts').then(r => r.json()),
      create:(content) => fetch('/api/posts', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content})}),
      update:(id, content) => fetch(`/api/posts/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content})}),
      remove:(id) => fetch(`/api/posts/${id}`, {method:'DELETE'})
    };

    /* -------- Utiles -------- */
    const esc = s => (s ?? '').replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]
    ));

    function updateCounter(){
      const len = (editor.innerText || '').trim().length;
      counter.textContent = `${len} ${len===1?'carácter':'caracteres'}`;
    }

    // Auto-grow vertical
    function autoGrow(el) {
      el.style.height = 'auto';
      const maxH = Math.max(window.innerHeight * 0.6, 300);
      const sh = el.scrollHeight;
      if (sh <= maxH) {
        el.style.overflowY = 'hidden';
        el.style.height = sh + 'px';
      } else {
        el.style.overflowY = 'auto';
        el.style.height = maxH + 'px';
      }
    }

    // Auto-grow horizontal: ocupa el ancho del padre
    function adjustWidth(el) {
      el.style.width = '100%';
      el.style.boxSizing = 'border-box';
    }

    function autoGrowTextarea(ta) {
      ta.style.height = 'auto';
      ta.style.height = ta.scrollHeight + 'px';
    }

    editor.addEventListener('input', () => { autoGrow(editor); updateCounter(); });
    window.addEventListener('resize', () => adjustWidth(editor));

    autoGrow(editor); updateCounter(); adjustWidth(editor);

    /* -------- Renderizado -------- */
    function render(items){
      list.innerHTML = '';
      if(!items.length){
        list.innerHTML = '<p class="muted">Aún no hay publicaciones.</p>';
        return;
      }
      items.forEach(p => {
        const card = document.createElement('div');
        card.className = 'post-card';
        card.dataset.id = p.id;

        card.innerHTML = `
          <div class="post-header">
            <div>
              <strong>${esc(p.author || 'Usuario')}</strong>
              <span class="post-meta"> · ${new Date(p.created_at).toLocaleString()}</span>
            </div>
            <div class="post-actions">
              ${p.editable ? `<a href="#" class="edit">Editar</a>
                              <a href="#" class="delete text-danger">Eliminar</a>` : ''}
            </div>
          </div>
          <div class="mt-2 post-content">${esc(p.content)}</div>
        `;

        if (p.editable){
          card.querySelector('.edit').addEventListener('click', (e)=>{
            e.preventDefault();
            startEdit(card, p);
          });
          card.querySelector('.delete').addEventListener('click', async (e)=>{
            e.preventDefault();
            if(confirm('¿Eliminar esta publicación?')){
              const r = await api.remove(p.id);
              if(r.ok) load();
            }
          });
        }

        list.appendChild(card);
      });
    }

    function startEdit(card, p){
      const box = card.querySelector('.post-content');
      const old = box.textContent;

      box.innerHTML = `
        <textarea class="textarea-like">${esc(old)}</textarea>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-primary save">Guardar</button>
          <button class="btn btn-soft cancel">Cancelar</button>
        </div>`;

      const ta = box.querySelector('textarea');
      autoGrowTextarea(ta);
      ta.addEventListener('input', () => autoGrowTextarea(ta));

      box.querySelector('.save').onclick = async ()=>{
        const text = (ta.value || '').trim();
        if(!text) return alert('El contenido no puede estar vacío.');
        const r = await api.update(p.id, text);
        if(r.ok) load();
      };
      box.querySelector('.cancel').onclick = ()=>{ box.textContent = old; };
    }

    /* -------- Acciones -------- */
    postBtn.addEventListener('click', async ()=>{
      const text = (editor.innerText || '').trim();
      if(!text) return alert('Escribe algo antes de publicar.');
      const r = await api.create(text);
      if(r.ok){
        editor.innerHTML = '';
        autoGrow(editor);
        updateCounter();
        load();
      }else{
        const data = await r.json().catch(()=>({}));
        alert(data.error || 'No se pudo publicar.');
      }
    });

    clearBtn.addEventListener('click', ()=>{
      editor.innerHTML = '';
      autoGrow(editor);
      updateCounter();
    });

    async function load(){
      try{
        const items = await api.list();
        render(items);
      }catch(e){
        list.innerHTML = '<div class="alert alert-danger">No se pudo cargar el foro.</div>';
      }
    }

    load();
  })();
  </script>
</body>
</html>
