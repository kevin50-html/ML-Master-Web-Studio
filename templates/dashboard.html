 {% extends "base.html" %} {# si usas base.html; si no, quita esta línea #}
{% block content %} 

<div class="container" style="max-width: 820px; margin: 24px auto;">
  <h2 class="mb-3">Comunidad</h2>

  <!-- Editor (contenteditable) -->
  <div class="card" style="border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px;">
    <div id="editor"
         contenteditable="true"
         aria-label="Escribe tu publicación"
         style="min-height:110px; outline:none; border:1px dashed #cbd5e1; border-radius:8px; padding:12px;"
         data-placeholder="Escribe algo…"></div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
      <button id="postBtn" class="btn btn-primary">Publicar</button>
      <button id="clearBtn" class="btn btn-light" type="button">Limpiar</button>
    </div>
    <small class="text-muted">Tip: el recuadro es editable (contenteditable).</small>
  </div>

  <!-- Lista de posts -->
  <div id="postsList" class="space-y"></div>
</div>

<style>
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:600}
  .btn-primary{background:#6366f1;color:#fff;border-color:#6366f1}
  .btn-primary:hover{opacity:.95}
  .btn-light:hover{background:#f1f5f9}
  .post-card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin-bottom:12px}
  .post-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .muted{color:#64748b}
  /* placeholder para contenteditable */
  #editor:empty:before{content:attr(data-placeholder); color:#94a3b8}
  .actions{display:flex; gap:8px}
  .link{color:#2563eb; cursor:pointer; text-decoration:none}
  .link:hover{text-decoration:underline}
  .textarea-like{width:100%; min-height:90px; border:1px solid #cbd5e1; border-radius:8px; padding:10px}
</style>

<script>
(async function () {
  const editor   = document.getElementById('editor');
  const postBtn  = document.getElementById('postBtn');
  const clearBtn = document.getElementById('clearBtn');
  const list     = document.getElementById('postsList');

  const api = {
    list:  () => fetch('/api/posts').then(r => r.json()),
    create:(content) => fetch('/api/posts', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content})}),
    update:(id, content) => fetch(`/api/posts/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content})}),
    remove:(id) => fetch(`/api/posts/${id}`, {method:'DELETE'})
  };

  function escHtml(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));}

  function render(items){
    list.innerHTML = '';
    if(!items.length){
      list.innerHTML = '<p class="muted">Aún no hay publicaciones.</p>';
      return;
    }
    items.forEach(p => {
      const div = document.createElement('div');
      div.className = 'post-card';
      div.dataset.id = p.id;

      div.innerHTML = `
        <div class="post-header">
          <div><strong>${escHtml(p.author || 'Usuario')}</strong>
            <span class="muted"> · ${new Date(p.created_at).toLocaleString()}</span>
          </div>
          <div class="actions">
            ${p.editable ? `
              <a class="link edit">Editar</a>
              <a class="link delete">Eliminar</a>
            ` : ''}
          </div>
        </div>
        <div class="post-content">${escHtml(p.content)}</div>
      `;

      if (p.editable){
        const editLink = div.querySelector('.edit');
        const delLink  = div.querySelector('.delete');

        editLink.addEventListener('click', () => startEdit(div, p));
        delLink.addEventListener('click', async () => {
          if(confirm('¿Eliminar esta publicación?')){
            const r = await api.remove(p.id);
            if(r.ok) load();
          }
        });
      }

      list.appendChild(div);
    });
  }

  function startEdit(container, p){
    const contentDiv = container.querySelector('.post-content');
    const old = contentDiv.textContent;

    contentDiv.innerHTML = `<textarea class="textarea-like">${escHtml(old)}</textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn btn-primary save">Guardar</button>
        <button class="btn btn-light cancel">Cancelar</button>
      </div>`;

    const ta = contentDiv.querySelector('textarea');
    // des-escape para edición
    ta.value = old;

    contentDiv.querySelector('.save').onclick = async () => {
      const text = (ta.value || '').trim();
      if(!text) return alert('El contenido no puede estar vacío.');
      const r = await api.update(p.id, text);
      if(r.ok) load();
    };
    contentDiv.querySelector('.cancel').onclick = () => {
      contentDiv.textContent = old;
    };
  }

  async function load(){
    const items = await api.list();
    render(items);
  }

  postBtn.addEventListener('click', async () => {
    const html = (editor.innerText || '').trim();
    if(!html) return alert('Escribe algo antes de publicar.');
    const r = await api.create(html);
    if(r.ok){
      editor.innerHTML = '';
      load();
    } else {
      const data = await r.json().catch(()=>({}));
      alert(data.error || 'No se pudo publicar.');
    }
  });

  clearBtn.addEventListener('click', () => editor.innerHTML = '');

  load();
})();
</script>

{% endblock %}
